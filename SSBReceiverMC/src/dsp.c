/*
 * Copyright (c) 2014-2015, TAKAHASHI Tomohiro (TTRFTECH) edy555@gmail.com
 * All rights reserved.
 *
 * This is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3, or (at your option)
 * any later version.
 *
 * The software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GNU Radio; see the file COPYING.  If not, write to
 * the Free Software Foundation, Inc., 51 Franklin Street,
 * Boston, MA 02110-1301, USA.
 */

#ifdef __USE_CMSIS
#include "LPC43xx.h"
#endif

#include <cr_section_macros.h>
#include <limits.h>
#include <arm_math.h>
#include "lpc43xx_i2s.h"
#include "receiver.h"
#include "vadc.h"

#define WEAVER_OFFSET_FREQ 1300

int mod_freq_offset[] = {
	-WEAVER_OFFSET_FREQ,
	WEAVER_OFFSET_FREQ
};

static modulation_t current_modulation;

void set_modulation(modulation_t modulation)
{
	current_modulation = modulation;
}

int32_t ovf_flags;
#define OVF_ADC (1<<0)
#define OVF_CIC (1<<1)
#define OVF_FIR (1<<2)
#define OVF_IIR (1<<3)

static inline void clear_qflag(void)
{
  __ASM("mrs r0, apsr");
  __ASM("bfc r0, #27, #1");
  __ASM("msr apsr_nzcvq, r0");
}

static inline int check_qflag(void)
{
  int out;
  __ASM("mrs r0, apsr");
  __ASM("ubfx %0, r0, #27, #1" : "=r" (out));
  return out;
}


float32_t freq_adjust = (458.0 / 7.1e6);

int16_t finenco_phasestep;
uint16_t finenco_phase;


__RAMFUNC(RAM)
void nco_set_frequency(int32_t freq, float32_t ampl)
{
	int16_t *costbl = NCO_SIN_TABLE;
	int16_t *sintbl = NCO_COS_TABLE;
	int32_t f;
	int i;

	freq += mod_freq_offset[current_modulation];
	freq += freq * freq_adjust;
	freq -= (int)(freq / ADC_RATE) * ADC_RATE;
	f = ((int64_t)freq * NCO_TABLE_SIZE + ADC_RATE/2) / ADC_RATE;
	for (i = 0; i < NCO_SAMPLES; i++) {
		float32_t phase = 2*PI*f*i/NCO_TABLE_SIZE;
		costbl[i] = (int16_t)(arm_cos_f32(phase) * ampl);
		sintbl[i] = (int16_t)(arm_sin_f32(phase) * ampl);
	}

	{
		int32_t tune = freq - (f * ADC_RATE)/NCO_TABLE_SIZE;
	    //printf("tune: %d\n", tune);
		finenco_phasestep = tune * 65536 / IF_RATE;
	    //printf("step: %d\n", finenco_phasestep);
	}
}


cic_state_t cic_i;
cic_state_t cic_q;

static void cic_init(void)
{
	memset(&cic_i, 0, sizeof cic_i);
	memset(&cic_q, 0, sizeof cic_q);
	cic_i.dest = I_FIR_BUFFER;
	cic_i.nco_base = NCO_SIN_TABLE;
	cic_q.dest = Q_FIR_BUFFER;
	cic_q.nco_base = NCO_COS_TABLE;
}

int32_t agc_gain = 256;
int32_t agc_multiplier = 4;
int32_t agc_rshift = 2;

__RAMFUNC(RAM)
void cic_decimate(cic_state_t *cic, uint8_t *buf, int len)
{
	int16_t *const dest = (int16_t*)cic->dest;
	uint32_t *const capture = (uint32_t*)buf;
	const uint32_t *const nco_base = (uint32_t*)cic->nco_base;

	int32_t s0 = cic->s0;
	int32_t s1 = cic->s1;
	int32_t d0 = cic->d0;
	int32_t d1 = cic->d1;
	int32_t e0, e1;
	int i, l;

	l = cic->dest_idx;
	for (i = 0; i < len / 4; ) {
		int j;
		for (j = 0; j < NCO_SAMPLES/2; ) {
#define CIC0()	do { \
			uint32_t f = nco_base[j++]; \
			uint32_t x = capture[i++]; \
			s0 = __SMLAD(x, f, s0); \
			s1 += s0; \
		} while(0)
#define CIC5()	CIC0();CIC0();CIC0();CIC0();CIC0()

			CIC5();CIC5();CIC5();CIC5();CIC5();
			CIC5();CIC5();CIC5();CIC5();CIC5();
			CIC5();CIC5();CIC5();CIC5();CIC5();

			e0 = d0 - s1;
			d0 = s1;
			e1 = d1 - e0;
			d1 = e0;
			e1 >>= agc_rshift;
			dest[l++] = __SSAT((e1 * agc_multiplier) >> 14, 16);
			l %=  FIR_BUFFER_SIZE/2;
		}
	}
	cic->dest_idx = l;
	cic->s0 = s0;
	cic->s1 = s1;
	cic->d0 = d0;
	cic->d1 = d1;
}



const int16_t cos_sin_table[256][4] = {
    { -32767,   10,      0, -804 },
    { -32757,   29,   -804, -804 },
    { -32728,   50,  -1608, -802 },
    { -32678,   69,  -2410, -802 },
    { -32609,   88,  -3212, -799 },
    { -32521,  109,  -4011, -797 },
    { -32412,  127,  -4808, -794 },
    { -32285,  148,  -5602, -791 },
    { -32137,  166,  -6393, -786 },
    { -31971,  186,  -7179, -783 },
    { -31785,  205,  -7962, -777 },
    { -31580,  224,  -8739, -773 },
    { -31356,  243,  -9512, -766 },
    { -31113,  261, -10278, -761 },
    { -30852,  281, -11039, -754 },
    { -30571,  298, -11793, -746 },
    { -30273,  317, -12539, -740 },
    { -29956,  335, -13279, -731 },
    { -29621,  353, -14010, -722 },
    { -29268,  370, -14732, -714 },
    { -28898,  388, -15446, -705 },
    { -28510,  405, -16151, -695 },
    { -28105,  422, -16846, -684 },
    { -27683,  438, -17530, -674 },
    { -27245,  455, -18204, -664 },
    { -26790,  471, -18868, -651 },
    { -26319,  487, -19519, -640 },
    { -25832,  503, -20159, -628 },
    { -25329,  518, -20787, -616 },
    { -24811,  532, -21403, -602 },
    { -24279,  548, -22005, -589 },
    { -23731,  561, -22594, -576 },
    { -23170,  576, -23170, -561 },
    { -22594,  589, -23731, -548 },
    { -22005,  602, -24279, -532 },
    { -21403,  616, -24811, -518 },
    { -20787,  628, -25329, -503 },
    { -20159,  640, -25832, -487 },
    { -19519,  651, -26319, -471 },
    { -18868,  664, -26790, -455 },
    { -18204,  674, -27245, -438 },
    { -17530,  684, -27683, -422 },
    { -16846,  695, -28105, -405 },
    { -16151,  705, -28510, -388 },
    { -15446,  714, -28898, -370 },
    { -14732,  722, -29268, -353 },
    { -14010,  731, -29621, -335 },
    { -13279,  740, -29956, -317 },
    { -12539,  746, -30273, -298 },
    { -11793,  754, -30571, -281 },
    { -11039,  761, -30852, -261 },
    { -10278,  766, -31113, -243 },
    { -9512,  773, -31356, -224 },
    { -8739,  777, -31580, -205 },
    { -7962,  783, -31785, -186 },
    { -7179,  786, -31971, -166 },
    { -6393,  791, -32137, -148 },
    { -5602,  794, -32285, -127 },
    { -4808,  797, -32412, -109 },
    { -4011,  799, -32521,  -88 },
    { -3212,  802, -32609,  -69 },
    { -2410,  802, -32678,  -50 },
    { -1608,  804, -32728,  -29 },
    {  -804,  804, -32757,  -10 },
    {     0,  804, -32767,   10 },
    {   804,  804, -32757,   29 },
    {  1608,  802, -32728,   50 },
    {  2410,  802, -32678,   69 },
    {  3212,  799, -32609,   88 },
    {  4011,  797, -32521,  109 },
    {  4808,  794, -32412,  127 },
    {  5602,  791, -32285,  148 },
    {  6393,  786, -32137,  166 },
    {  7179,  783, -31971,  186 },
    {  7962,  777, -31785,  205 },
    {  8739,  773, -31580,  224 },
    {  9512,  766, -31356,  243 },
    { 10278,  761, -31113,  261 },
    { 11039,  754, -30852,  281 },
    { 11793,  746, -30571,  298 },
    { 12539,  740, -30273,  317 },
    { 13279,  731, -29956,  335 },
    { 14010,  722, -29621,  353 },
    { 14732,  714, -29268,  370 },
    { 15446,  705, -28898,  388 },
    { 16151,  695, -28510,  405 },
    { 16846,  684, -28105,  422 },
    { 17530,  674, -27683,  438 },
    { 18204,  664, -27245,  455 },
    { 18868,  651, -26790,  471 },
    { 19519,  640, -26319,  487 },
    { 20159,  628, -25832,  503 },
    { 20787,  616, -25329,  518 },
    { 21403,  602, -24811,  532 },
    { 22005,  589, -24279,  548 },
    { 22594,  576, -23731,  561 },
    { 23170,  561, -23170,  576 },
    { 23731,  548, -22594,  589 },
    { 24279,  532, -22005,  602 },
    { 24811,  518, -21403,  616 },
    { 25329,  503, -20787,  628 },
    { 25832,  487, -20159,  640 },
    { 26319,  471, -19519,  651 },
    { 26790,  455, -18868,  664 },
    { 27245,  438, -18204,  674 },
    { 27683,  422, -17530,  684 },
    { 28105,  405, -16846,  695 },
    { 28510,  388, -16151,  705 },
    { 28898,  370, -15446,  714 },
    { 29268,  353, -14732,  722 },
    { 29621,  335, -14010,  731 },
    { 29956,  317, -13279,  740 },
    { 30273,  298, -12539,  746 },
    { 30571,  281, -11793,  754 },
    { 30852,  261, -11039,  761 },
    { 31113,  243, -10278,  766 },
    { 31356,  224,  -9512,  773 },
    { 31580,  205,  -8739,  777 },
    { 31785,  186,  -7962,  783 },
    { 31971,  166,  -7179,  786 },
    { 32137,  148,  -6393,  791 },
    { 32285,  127,  -5602,  794 },
    { 32412,  109,  -4808,  797 },
    { 32521,   88,  -4011,  799 },
    { 32609,   69,  -3212,  802 },
    { 32678,   50,  -2410,  802 },
    { 32728,   29,  -1608,  804 },
    { 32757,   10,   -804,  804 },
    { 32767,  -10,      0,  804 },
    { 32757,  -29,    804,  804 },
    { 32728,  -50,   1608,  802 },
    { 32678,  -69,   2410,  802 },
    { 32609,  -88,   3212,  799 },
    { 32521, -109,   4011,  797 },
    { 32412, -127,   4808,  794 },
    { 32285, -148,   5602,  791 },
    { 32137, -166,   6393,  786 },
    { 31971, -186,   7179,  783 },
    { 31785, -205,   7962,  777 },
    { 31580, -224,   8739,  773 },
    { 31356, -243,   9512,  766 },
    { 31113, -261,  10278,  761 },
    { 30852, -281,  11039,  754 },
    { 30571, -298,  11793,  746 },
    { 30273, -317,  12539,  740 },
    { 29956, -335,  13279,  731 },
    { 29621, -353,  14010,  722 },
    { 29268, -370,  14732,  714 },
    { 28898, -388,  15446,  705 },
    { 28510, -405,  16151,  695 },
    { 28105, -422,  16846,  684 },
    { 27683, -438,  17530,  674 },
    { 27245, -455,  18204,  664 },
    { 26790, -471,  18868,  651 },
    { 26319, -487,  19519,  640 },
    { 25832, -503,  20159,  628 },
    { 25329, -518,  20787,  616 },
    { 24811, -532,  21403,  602 },
    { 24279, -548,  22005,  589 },
    { 23731, -561,  22594,  576 },
    { 23170, -576,  23170,  561 },
    { 22594, -589,  23731,  548 },
    { 22005, -602,  24279,  532 },
    { 21403, -616,  24811,  518 },
    { 20787, -628,  25329,  503 },
    { 20159, -640,  25832,  487 },
    { 19519, -651,  26319,  471 },
    { 18868, -664,  26790,  455 },
    { 18204, -674,  27245,  438 },
    { 17530, -684,  27683,  422 },
    { 16846, -695,  28105,  405 },
    { 16151, -705,  28510,  388 },
    { 15446, -714,  28898,  370 },
    { 14732, -722,  29268,  353 },
    { 14010, -731,  29621,  335 },
    { 13279, -740,  29956,  317 },
    { 12539, -746,  30273,  298 },
    { 11793, -754,  30571,  281 },
    { 11039, -761,  30852,  261 },
    { 10278, -766,  31113,  243 },
    {  9512, -773,  31356,  224 },
    {  8739, -777,  31580,  205 },
    {  7962, -783,  31785,  186 },
    {  7179, -786,  31971,  166 },
    {  6393, -791,  32137,  148 },
    {  5602, -794,  32285,  127 },
    {  4808, -797,  32412,  109 },
    {  4011, -799,  32521,   88 },
    {  3212, -802,  32609,   69 },
    {  2410, -802,  32678,   50 },
    {  1608, -804,  32728,   29 },
    {   804, -804,  32757,   10 },
    {     0, -804,  32767,  -10 },
    {  -804, -804,  32757,  -29 },
    { -1608, -802,  32728,  -50 },
    { -2410, -802,  32678,  -69 },
    { -3212, -799,  32609,  -88 },
    { -4011, -797,  32521, -109 },
    { -4808, -794,  32412, -127 },
    { -5602, -791,  32285, -148 },
    { -6393, -786,  32137, -166 },
    { -7179, -783,  31971, -186 },
    { -7962, -777,  31785, -205 },
    { -8739, -773,  31580, -224 },
    { -9512, -766,  31356, -243 },
    { -10278, -761,  31113, -261 },
    { -11039, -754,  30852, -281 },
    { -11793, -746,  30571, -298 },
    { -12539, -740,  30273, -317 },
    { -13279, -731,  29956, -335 },
    { -14010, -722,  29621, -353 },
    { -14732, -714,  29268, -370 },
    { -15446, -705,  28898, -388 },
    { -16151, -695,  28510, -405 },
    { -16846, -684,  28105, -422 },
    { -17530, -674,  27683, -438 },
    { -18204, -664,  27245, -455 },
    { -18868, -651,  26790, -471 },
    { -19519, -640,  26319, -487 },
    { -20159, -628,  25832, -503 },
    { -20787, -616,  25329, -518 },
    { -21403, -602,  24811, -532 },
    { -22005, -589,  24279, -548 },
    { -22594, -576,  23731, -561 },
    { -23170, -561,  23170, -576 },
    { -23731, -548,  22594, -589 },
    { -24279, -532,  22005, -602 },
    { -24811, -518,  21403, -616 },
    { -25329, -503,  20787, -628 },
    { -25832, -487,  20159, -640 },
    { -26319, -471,  19519, -651 },
    { -26790, -455,  18868, -664 },
    { -27245, -438,  18204, -674 },
    { -27683, -422,  17530, -684 },
    { -28105, -405,  16846, -695 },
    { -28510, -388,  16151, -705 },
    { -28898, -370,  15446, -714 },
    { -29268, -353,  14732, -722 },
    { -29621, -335,  14010, -731 },
    { -29956, -317,  13279, -740 },
    { -30273, -298,  12539, -746 },
    { -30571, -281,  11793, -754 },
    { -30852, -261,  11039, -761 },
    { -31113, -243,  10278, -766 },
    { -31356, -224,   9512, -773 },
    { -31580, -205,   8739, -777 },
    { -31785, -186,   7962, -783 },
    { -31971, -166,   7179, -786 },
    { -32137, -148,   6393, -791 },
    { -32285, -127,   5602, -794 },
    { -32412, -109,   4808, -797 },
    { -32521,  -88,   4011, -799 },
    { -32609,  -69,   3212, -802 },
    { -32678,  -50,   2410, -802 },
    { -32728,  -29,   1608, -804 },
    { -32757,  -10,    804, -804 }
};

static inline
uint32_t cos_sin(uint16_t phase, int shift)
{
    uint16_t idx = phase / 256;
    uint16_t mod = phase & 0xff;
    uint32_t r = __PKHBT(0x0100, mod, 16);
    uint32_t *e = (uint32_t *)&cos_sin_table[idx];
    uint32_t cd = e[0];
    uint32_t sd = e[1];
    int32_t c = __SMUAD(r, cd);
    int32_t s = __SMUAD(r, sd);
    c /= 256;
    s /= 256;
    return __PKHBT(s, c, 16);
}

__RAMFUNC(RAM)
void finetune_mixer()
{
	uint32_t *src1 = (uint32_t *)I_FIR_BUFFER;
	uint32_t *src2 = (uint32_t *)Q_FIR_BUFFER;
	int size = FIR_BUFFER_SIZE;
	while (size > 0) {
		uint32_t cossin0 = cos_sin(finenco_phase, 0);
		finenco_phase += finenco_phasestep;
		uint32_t cossin1 = cos_sin(finenco_phase, 0);
		finenco_phase += finenco_phasestep;
		uint32_t i0i1 = *src1;
		uint32_t q0q1 = *src2;
		uint32_t i0q0 = __PKHTB(i0i1, q0q1, 16);
		uint32_t i1q1 = __PKHBT(q0q1, i0i1, 16);
		int32_t i0 = __SMLSD(i0q0, cossin0, 0);
		int32_t i1 = __SMLSD(i1q1, cossin1, 0);
		*src1++ = __PKHTB(i0, i1, 16);
		int32_t q0 = __SMLADX(i0q0, cossin0, 0);
		int32_t q1 = __SMLADX(i1q1, cossin1, 0);
		*src2++ = __PKHTB(q0, q1, 16);
		size -= 4;
	}
}

#define RESAMPLE_NUM_TAPS	64

// two arrays of same FIR coefficients for even and odd alignment sample
q15_t decimate_fir_coeff[2][RESAMPLE_NUM_TAPS] = {
	{ -61, -51, -69, -89, -109, -130, -148, -163, -172, -173, -165, -146, -112, -64,   0,  80, 177, 290, 417, 557, 707, 863, 1023, 1181, 1335, 1478, 1608, 1720, 1812, 1879, 1920, 1934, 1920, 1879, 1812, 1720, 1608, 1478, 1335, 1181, 1023, 863, 707, 557, 417, 290, 177,  80,   0, -64, -112, -146, -165, -173, -172, -163, -148, -130, -109, -89, -69, -51, -61, 0 },
	{ 0, -61, -51, -69, -89, -109, -130, -148, -163, -172, -173, -165, -146, -112, -64,   0,  80, 177, 290, 417, 557, 707, 863, 1023, 1181, 1335, 1478, 1608, 1720, 1812, 1879, 1920, 1934, 1920, 1879, 1812, 1720, 1608, 1478, 1335, 1181, 1023, 863, 707, 557, 417, 290, 177,  80,   0, -64, -112, -146, -165, -173, -172, -163, -148, -130, -109, -89, -69, -51, -61 }
};

am_demod_state_t am_demod_state;

volatile struct {
	uint16_t write_current;
	uint16_t write_total;
	uint16_t read_total;
	uint16_t read_current;
	uint16_t rebuffer_count;
} audio_state;

__RAMFUNC(RAM)
void resample_fir_filter()
{
	const uint32_t *coeff;
	const uint16_t *src1 = (const uint16_t *)I_FIR_STATE;
	const uint16_t *src2 = (const uint16_t *)Q_FIR_STATE;
	const uint32_t *s1, *s2;
	int32_t tail = FIR_BUFFER_SIZE;
	int32_t idx = 0;
	int32_t acc1, acc2;
	int i, j;
	uint16_t *dest1 = (uint16_t *)IIR_I_BUFFER;
	uint16_t *dest2 = (uint16_t *)IIR_Q_BUFFER;

	while (idx < tail) {
		coeff = (uint32_t*)decimate_fir_coeff[idx % 2];
		acc1 = 0;
		acc2 = 0;
		s1 = (const uint32_t*)&src1[idx >> 1];
		s2 = (const uint32_t*)&src2[idx >> 1];
		for (j = 0; j < RESAMPLE_NUM_TAPS / 2; j++) {
			uint32_t x1 = *s1++;
			uint32_t x2 = *s2++;
			acc1 = __SMLAD(x1, *coeff, acc1);
			acc2 = __SMLAD(x2, *coeff, acc2);
			coeff++;
		}
		*dest1++ = __SSAT(acc1 >> 12, 16);
		*dest2++ = __SSAT(acc2 >> 12, 16);
		idx += 10*2; /* 1/10 decimation: 2 samples per loop */
	}

	uint32_t *state = (uint32_t *)I_FIR_STATE;
	src1 = &src1[tail / sizeof(*src1)];
	for (i = 0; i < FIR_STATE_SIZE / sizeof(uint32_t); i++) {
		//*state++ = *src1++;
	    __asm__ volatile ("ldr r0, [%0], #+4\n" : : "r" (src1) : "r0");
	    __asm__ volatile ("str r0, [%0], #+4\n" : : "r" (state) : "r0");
	}
	state = (uint32_t *)Q_FIR_STATE;
	src2 = &src2[tail / sizeof(*src2)];
	for (i = 0; i < FIR_STATE_SIZE / sizeof(uint32_t); i++) {
		//*state++ = *src2++;
	    __asm__ volatile ("ldr r0, [%0], #+4\n" : : "r" (src2) : "r0");
	    __asm__ volatile ("str r0, [%0], #+4\n" : : "r" (state) : "r0");
	}
}

// Bi-Quad IIR Filter state
q15_t bq_i_state[4 * 3];
q15_t bq_q_state[4 * 3];
// 6th order elliptic lowpass filter fc=1300Hz
q15_t bq_coeffs[] = {
#if 1
		 1186, 0,   1108,  1186, 20883,  -8328,
		 6829, 0,  -4129,  6829, 17973, -13228,
		16384, 0, -14411, 16384, 16788, -15733
#else
		 651, 0,   -328,   651, 27196, -11823,
		5592, 0,  -8854,  5592, 27830, -14568,
	   16384, 0, -27663, 16384, 28264, -16007
#endif
};
arm_biquad_casd_df1_inst_q15 bq_i = { 3, bq_i_state, bq_coeffs, 1};
arm_biquad_casd_df1_inst_q15 bq_q = { 3, bq_q_state, bq_coeffs, 1};

uint16_t weavernco_phase = 0;
int16_t weavernco_phasestep = 65536L*WEAVER_OFFSET_FREQ/8000;

void agc_update(int ampl);

__RAMFUNC(RAM)
void
weaver_ssb_demod(int usb)
{
	arm_biquad_cascade_df1_q15(&bq_i, IIR_I_BUFFER, AUD_I_BUFFER, IIR_BUFFER_SIZE/2);
	arm_biquad_cascade_df1_q15(&bq_q, IIR_Q_BUFFER, AUD_Q_BUFFER, IIR_BUFFER_SIZE/2);

	int phasestep = usb ? weavernco_phasestep : -weavernco_phasestep;
	q15_t *src1 = AUD_I_BUFFER;
	q15_t *src2 = AUD_Q_BUFFER;
	int size = IIR_BUFFER_SIZE/2;
	uint16_t *dest = (uint16_t *)AUDIO_BUFFER;
	uint16_t *p = (uint16_t *)AUD_BUFFER;
	int cur = audio_state.write_current;
	int32_t acc = 0;
	while (size-- > 0) {
		uint32_t cossin = cos_sin(weavernco_phase, 0);
		weavernco_phase += phasestep;
		uint32_t i = *src1++;
		uint32_t q = *src2++;
		uint32_t iq = __PKHBT(i, q, 16);
		int32_t r = __SMLAD(iq, cossin, 0);
		acc = __SMLAD(iq, iq, acc); /* i*i + q*q */
		dest[cur++] = r >> 16;
		dest[cur++] = r >> 16;
		*p++ = r >> 16;
		cur %= AUDIO_BUFFER_SIZE / 2;
	    audio_state.write_total += 2;
	}
	am_demod_state.average = __USAT(acc >> 16, 16);
	agc_update(am_demod_state.average);
    audio_state.write_current = cur;
}

#define AGC_IMM_ATTACK_THRESHOLD 20000
int16_t agc_slowness = 1; // attack and release ratio (-1: agc disabled)
int32_t agc_target_level = 4000;
static int32_t agc_integration = 0;
#define AGC_INT_THRESHOLD 32768

void
agc_update(int32_t ampl)
{
	if (agc_slowness <= 0)
		// agc disabled
		return;

	if (ampl > AGC_IMM_ATTACK_THRESHOLD) {
		// halving agc gain on attack immediately
		agc_gain = (agc_gain >> 3)+1;
	} else {
		int32_t diff = ampl - agc_target_level;
		if (diff > 0)
			agc_integration += diff; // fast attack
		else
			agc_integration += diff / agc_slowness; // slow relese

		if (agc_integration > AGC_INT_THRESHOLD) {
			int32_t delta = agc_gain * agc_integration / (AGC_INT_THRESHOLD * 8) + 1;
			agc_gain -= delta;
			if (agc_gain < 1)
				agc_gain = 1;
			agc_integration = 0;
		} else if (agc_integration < -AGC_INT_THRESHOLD) {
			int32_t delta = agc_gain * (-agc_integration) / (AGC_INT_THRESHOLD * 8) + 1;
			agc_gain += delta;
			if (agc_gain > 32767)
				agc_gain = 32767;
			agc_integration = 0;
		} else {
			// no update agc
			return;
		}
	}
	// resolve gain into rshift and coefficient
	{
		int32_t g = agc_gain;
		int r = 8;
		if (g >= 8 * 16) {
			g >>= 4;
			r -= 4;
		}
		while (g > 8 && r > 0) {
			g >>= 1;
			r -= 1;
		}
		agc_rshift = r;
		agc_multiplier = g;
	}
}


/*
void generate_test_tone(int freq)
{
	int i;
	int16_t *buf = (int16_t*)AUDIO_BUFFER;
	int samples = AUDIO_BUFFER_SIZE / 2;
	int n = freq * samples / 48000;
	for (i = 0; i < AUDIO_BUFFER_SIZE / 2; i++) {
		float res = arm_sin_f32(((float)i * 2.0 * PI * n) / 4096);
		buf[i] = (int)(res * 1500.0) + 1500;
	}
}
*/
/*
void test_cos_sin()
{
	uint16_t phase = 0;
	int i, j;
	for (j = 0; j < 16; j++) {
		for (i = 0; i < 16; i++) {
			printf("%x ", cos_sin(phase, 0));
			phase += 500;
		}
		printf("\n");
	}
}
*/

// half of 1024pt window function
const int16_t winfunc_table[] = {
#if 1
		// hamming
		 2621,  2622,  2622,  2624,  2626,  2628,  2632,  2635,
		 2640,  2644,  2650,  2656,  2662,  2669,  2677,  2685,
		 2694,  2703,  2713,  2724,  2735,  2747,  2759,  2772,
		 2785,  2799,  2813,  2828,  2844,  2860,  2877,  2894,
		 2912,  2930,  2949,  2968,  2988,  3009,  3030,  3052,
		 3074,  3097,  3120,  3144,  3168,  3193,  3219,  3245,
		 3272,  3299,  3327,  3355,  3384,  3413,  3443,  3473,
		 3504,  3536,  3568,  3600,  3633,  3667,  3701,  3736,
		 3771,  3807,  3843,  3880,  3917,  3955,  3993,  4032,
		 4071,  4111,  4152,  4192,  4234,  4276,  4318,  4361,
		 4405,  4448,  4493,  4538,  4583,  4629,  4676,  4722,
		 4770,  4818,  4866,  4915,  4964,  5014,  5064,  5115,
		 5166,  5218,  5270,  5323,  5376,  5430,  5484,  5538,
		 5593,  5649,  5704,  5761,  5818,  5875,  5932,  5991,
		 6049,  6108,  6168,  6227,  6288,  6348,  6410,  6471,
		 6533,  6596,  6659,  6722,  6785,  6850,  6914,  6979,
		 7044,  7110,  7176,  7243,  7310,  7377,  7444,  7513,
		 7581,  7650,  7719,  7789,  7859,  7929,  8000,  8071,
		 8142,  8214,  8286,  8359,  8431,  8505,  8578,  8652,
		 8726,  8801,  8876,  8951,  9027,  9103,  9179,  9255,
		 9332,  9409,  9487,  9565,  9643,  9721,  9800,  9879,
		 9958, 10038, 10118, 10198, 10278, 10359, 10440, 10521,
		10603, 10685, 10767, 10849, 10932, 11015, 11098, 11181,
		11265, 11349, 11433, 11517, 11602, 11686, 11771, 11857,
		11942, 12028, 12114, 12200, 12286, 12373, 12459, 12546,
		12633, 12721, 12808, 12896, 12984, 13072, 13160, 13248,
		13337, 13425, 13514, 13603, 13693, 13782, 13871, 13961,
		14051, 14141, 14231, 14321, 14411, 14502, 14592, 14683,
		14773, 14864, 14955, 15046, 15138, 15229, 15320, 15412,
		15503, 15595, 15687, 15778, 15870, 15962, 16054, 16146,
		16238, 16331, 16423, 16515, 16607, 16700, 16792, 16885,
		16977, 17069, 17162, 17255, 17347, 17440, 17532, 17625,
		17717, 17810, 17902, 17995, 18088, 18180, 18273, 18365,
		18458, 18550, 18642, 18735, 18827, 18919, 19012, 19104,
		19196, 19288, 19380, 19472, 19564, 19656, 19748, 19839,
		19931, 20022, 20114, 20205, 20296, 20387, 20479, 20569,
		20660, 20751, 20842, 20932, 21022, 21113, 21203, 21293,
		21383, 21472, 21562, 21651, 21740, 21830, 21918, 22007,
		22096, 22184, 22273, 22361, 22449, 22536, 22624, 22711,
		22799, 22886, 22972, 23059, 23145, 23232, 23318, 23403,
		23489, 23574, 23659, 23744, 23829, 23914, 23998, 24082,
		24165, 24249, 24332, 24415, 24498, 24580, 24663, 24745,
		24826, 24908, 24989, 25070, 25150, 25231, 25311, 25390,
		25470, 25549, 25628, 25706, 25785, 25863, 25940, 26018,
		26095, 26171, 26248, 26324, 26400, 26475, 26550, 26625,
		26699, 26773, 26847, 26920, 26993, 27066, 27138, 27210,
		27282, 27353, 27424, 27495, 27565, 27635, 27704, 27773,
		27842, 27910, 27978, 28045, 28112, 28179, 28245, 28311,
		28377, 28442, 28507, 28571, 28635, 28698, 28761, 28824,
		28886, 28948, 29009, 29070, 29131, 29191, 29251, 29310,
		29369, 29427, 29485, 29542, 29599, 29656, 29712, 29768,
		29823, 29877, 29932, 29986, 30039, 30092, 30144, 30196,
		30248, 30299, 30349, 30399, 30449, 30498, 30546, 30595,
		30642, 30689, 30736, 30782, 30828, 30873, 30918, 30962,
		31006, 31049, 31091, 31134, 31175, 31216, 31257, 31297,
		31337, 31376, 31414, 31453, 31490, 31527, 31564, 31600,
		31635, 31670, 31704, 31738, 31772, 31804, 31837, 31869,
		31900, 31930, 31961, 31990, 32019, 32048, 32076, 32103,
		32130, 32156, 32182, 32208, 32232, 32256, 32280, 32303,
		32326, 32348, 32369, 32390, 32410, 32430, 32449, 32468,
		32486, 32503, 32520, 32537, 32553, 32568, 32583, 32597,
		32610, 32623, 32636, 32648, 32659, 32670, 32680, 32690,
		32699, 32707, 32715, 32723, 32729, 32736, 32741, 32746,
		32751, 32755, 32758, 32761, 32764, 32765, 32766, 32767,

		32767, 32766, 32765, 32764, 32761, 32758, 32755, 32751,
		32746, 32741, 32736, 32729, 32723, 32715, 32707, 32699,
		32690, 32680, 32670, 32659, 32648, 32636, 32623, 32610,
		32597, 32583, 32568, 32553, 32537, 32520, 32503, 32486,
		32468, 32449, 32430, 32410, 32390, 32369, 32348, 32326,
		32303, 32280, 32256, 32232, 32208, 32182, 32156, 32130,
		32103, 32076, 32048, 32019, 31990, 31961, 31930, 31900,
		31869, 31837, 31804, 31772, 31738, 31704, 31670, 31635,
		31600, 31564, 31527, 31490, 31453, 31414, 31376, 31337,
		31297, 31257, 31216, 31175, 31134, 31091, 31049, 31006,
		30962, 30918, 30873, 30828, 30782, 30736, 30689, 30642,
		30595, 30546, 30498, 30449, 30399, 30349, 30299, 30248,
		30196, 30144, 30092, 30039, 29986, 29932, 29877, 29823,
		29768, 29712, 29656, 29599, 29542, 29485, 29427, 29369,
		29310, 29251, 29191, 29131, 29070, 29009, 28948, 28886,
		28824, 28761, 28698, 28635, 28571, 28507, 28442, 28377,
		28311, 28245, 28179, 28112, 28045, 27978, 27910, 27842,
		27773, 27704, 27635, 27565, 27495, 27424, 27353, 27282,
		27210, 27138, 27066, 26993, 26920, 26847, 26773, 26699,
		26625, 26550, 26475, 26400, 26324, 26248, 26171, 26095,
		26018, 25940, 25863, 25785, 25706, 25628, 25549, 25470,
		25390, 25311, 25231, 25150, 25070, 24989, 24908, 24826,
		24745, 24663, 24580, 24498, 24415, 24332, 24249, 24165,
		24082, 23998, 23914, 23829, 23744, 23659, 23574, 23489,
		23403, 23318, 23232, 23145, 23059, 22972, 22886, 22799,
		22711, 22624, 22536, 22449, 22361, 22273, 22184, 22096,
		22007, 21918, 21830, 21740, 21651, 21562, 21472, 21383,
		21293, 21203, 21113, 21022, 20932, 20842, 20751, 20660,
		20569, 20479, 20387, 20296, 20205, 20114, 20022, 19931,
		19839, 19748, 19656, 19564, 19472, 19380, 19288, 19196,
		19104, 19012, 18919, 18827, 18735, 18642, 18550, 18458,
		18365, 18273, 18180, 18088, 17995, 17902, 17810, 17717,
		17625, 17532, 17440, 17347, 17255, 17162, 17069, 16977,
		16885, 16792, 16700, 16607, 16515, 16423, 16331, 16238,
		16146, 16054, 15962, 15870, 15778, 15687, 15595, 15503,
		15412, 15320, 15229, 15138, 15046, 14955, 14864, 14773,
		14683, 14592, 14502, 14411, 14321, 14231, 14141, 14051,
		13961, 13871, 13782, 13693, 13603, 13514, 13425, 13337,
		13248, 13160, 13072, 12984, 12896, 12808, 12721, 12633,
		12546, 12459, 12373, 12286, 12200, 12114, 12028, 11942,
		11857, 11771, 11686, 11602, 11517, 11433, 11349, 11265,
		11181, 11098, 11015, 10932, 10849, 10767, 10685, 10603,
		10521, 10440, 10359, 10278, 10198, 10118, 10038,  9958,
		 9879,  9800,  9721,  9643,  9565,  9487,  9409,  9332,
		 9255,  9179,  9103,  9027,  8951,  8876,  8801,  8726,
		 8652,  8578,  8505,  8431,  8359,  8286,  8214,  8142,
		 8071,  8000,  7929,  7859,  7789,  7719,  7650,  7581,
		 7513,  7444,  7377,  7310,  7243,  7176,  7110,  7044,
		 6979,  6914,  6850,  6785,  6722,  6659,  6596,  6533,
		 6471,  6410,  6348,  6288,  6227,  6168,  6108,  6049,
		 5991,  5932,  5875,  5818,  5761,  5704,  5649,  5593,
		 5538,  5484,  5430,  5376,  5323,  5270,  5218,  5166,
		 5115,  5064,  5014,  4964,  4915,  4866,  4818,  4770,
		 4722,  4676,  4629,  4583,  4538,  4493,  4448,  4405,
		 4361,  4318,  4276,  4234,  4192,  4152,  4111,  4071,
		 4032,  3993,  3955,  3917,  3880,  3843,  3807,  3771,
		 3736,  3701,  3667,  3633,  3600,  3568,  3536,  3504,
		 3473,  3443,  3413,  3384,  3355,  3327,  3299,  3272,
		 3245,  3219,  3193,  3168,  3144,  3120,  3097,  3074,
		 3052,  3030,  3009,  2988,  2968,  2949,  2930,  2912,
		 2894,  2877,  2860,  2844,  2828,  2813,  2799,  2785,
		 2772,  2759,  2747,  2735,  2724,  2713,  2703,  2694,
		 2685,  2677,  2669,  2662,  2656,  2650,  2644,  2640,
		 2635,  2632,  2628,  2626,  2624,  2622,  2622,  2621
#else
		 // blackman-harris
		    2,     2,     2,     2,     2,     2,     3,     3,
		    3,     3,     4,     4,     5,     5,     5,     6,
		    7,     7,     8,     8,     9,    10,    11,    12,
		   13,    14,    15,    16,    17,    18,    19,    20,
		   22,    23,    24,    26,    27,    29,    31,    32,
		   34,    36,    38,    40,    42,    44,    46,    48,
		   51,    53,    56,    58,    61,    64,    67,    70,
		   73,    76,    79,    82,    86,    89,    93,    97,
		  100,   104,   109,   113,   117,   122,   126,   131,
		  136,   141,   146,   151,   156,   162,   168,   173,
		  179,   186,   192,   198,   205,   212,   219,   226,
		  233,   241,   249,   256,   265,   273,   281,   290,
		  299,   308,   317,   327,   337,   347,   357,   367,
		  378,   389,   400,   411,   423,   435,   447,   459,
		  472,   485,   498,   512,   526,   540,   554,   569,
		  584,   599,   614,   630,   646,   663,   680,   697,
		  714,   732,   750,   769,   788,   807,   827,   846,
		  867,   887,   908,   930,   952,   974,   996,  1019,
		 1043,  1066,  1091,  1115,  1140,  1166,  1192,  1218,
		 1245,  1272,  1299,  1327,  1356,  1385,  1414,  1444,
		 1475,  1506,  1537,  1569,  1601,  1634,  1667,  1701,
		 1735,  1770,  1805,  1841,  1878,  1915,  1952,  1990,
		 2029,  2068,  2107,  2147,  2188,  2229,  2271,  2314,
		 2357,  2400,  2444,  2489,  2534,  2580,  2627,  2674,
		 2721,  2770,  2819,  2868,  2918,  2969,  3020,  3072,
		 3125,  3178,  3232,  3287,  3342,  3398,  3454,  3511,
		 3569,  3628,  3687,  3746,  3807,  3868,  3930,  3992,
		 4055,  4119,  4183,  4249,  4314,  4381,  4448,  4516,
		 4585,  4654,  4724,  4794,  4866,  4938,  5010,  5084,
		 5158,  5233,  5308,  5385,  5462,  5539,  5618,  5697,
		 5776,  5857,  5938,  6020,  6103,  6186,  6270,  6355,
		 6440,  6526,  6613,  6700,  6789,  6878,  6967,  7058,
		 7149,  7240,  7333,  7426,  7520,  7614,  7710,  7805,
		 7902,  7999,  8097,  8196,  8295,  8395,  8496,  8597,
		 8699,  8802,  8905,  9009,  9114,  9219,  9325,  9431,
		 9539,  9646,  9755,  9864,  9974, 10084, 10195, 10306,
		10419, 10531, 10645, 10759, 10873, 10988, 11104, 11220,
		11337, 11454, 11572, 11691, 11810, 11929, 12049, 12170,
		12291, 12412, 12534, 12657, 12780, 12903, 13027, 13152,
		13277, 13402, 13528, 13654, 13781, 13908, 14035, 14163,
		14291, 14420, 14549, 14678, 14808, 14938, 15068, 15199,
		15330, 15461, 15593, 15725, 15857, 15989, 16122, 16255,
		16388, 16522, 16655, 16789, 16923, 17058, 17192, 17327,
		17461, 17596, 17731, 17867, 18002, 18137, 18273, 18408,
		18544, 18680, 18815, 18951, 19087, 19223, 19358, 19494,
		19630, 19765, 19901, 20037, 20172, 20308, 20443, 20578,
		20713, 20848, 20983, 21118, 21252, 21386, 21520, 21654,
		21788, 21921, 22054, 22187, 22320, 22452, 22584, 22716,
		22847, 22978, 23109, 23239, 23369, 23499, 23628, 23757,
		23885, 24013, 24140, 24267, 24394, 24520, 24645, 24770,
		24894, 25018, 25142, 25264, 25386, 25508, 25629, 25749,
		25869, 25988, 26106, 26224, 26341, 26457, 26573, 26688,
		26802, 26915, 27028, 27139, 27251, 27361, 27470, 27579,
		27687, 27794, 27900, 28005, 28109, 28213, 28315, 28417,
		28518, 28617, 28716, 28814, 28911, 29007, 29102, 29196,
		29288, 29380, 29471, 29561, 29650, 29737, 29824, 29909,
		29994, 30077, 30159, 30240, 30320, 30399, 30477, 30553,
		30628, 30702, 30775, 30847, 30918, 30987, 31055, 31122,
		31188, 31252, 31315, 31377, 31438, 31497, 31555, 31612,
		31667, 31721, 31774, 31826, 31876, 31925, 31972, 32019,
		32064, 32107, 32149, 32190, 32230, 32268, 32304, 32340,
		32374, 32406, 32438, 32467, 32496, 32523, 32548, 32573,
		32595, 32617, 32637, 32655, 32672, 32688, 32702, 32715,
		32727, 32737, 32745, 32753, 32758, 32763, 32765, 32767,

		32767, 32765, 32763, 32758, 32753, 32745, 32737, 32727,
		32715, 32702, 32688, 32672, 32655, 32637, 32617, 32595,
		32573, 32548, 32523, 32496, 32467, 32438, 32406, 32374,
		32340, 32304, 32268, 32230, 32190, 32149, 32107, 32064,
		32019, 31972, 31925, 31876, 31826, 31774, 31721, 31667,
		31612, 31555, 31497, 31438, 31377, 31315, 31252, 31188,
		31122, 31055, 30987, 30918, 30847, 30775, 30702, 30628,
		30553, 30477, 30399, 30320, 30240, 30159, 30077, 29994,
		29909, 29824, 29737, 29650, 29561, 29471, 29380, 29288,
		29196, 29102, 29007, 28911, 28814, 28716, 28617, 28518,
		28417, 28315, 28213, 28109, 28005, 27900, 27794, 27687,
		27579, 27470, 27361, 27251, 27139, 27028, 26915, 26802,
		26688, 26573, 26457, 26341, 26224, 26106, 25988, 25869,
		25749, 25629, 25508, 25386, 25264, 25142, 25018, 24894,
		24770, 24645, 24520, 24394, 24267, 24140, 24013, 23885,
		23757, 23628, 23499, 23369, 23239, 23109, 22978, 22847,
		22716, 22584, 22452, 22320, 22187, 22054, 21921, 21788,
		21654, 21520, 21386, 21252, 21118, 20983, 20848, 20713,
		20578, 20443, 20308, 20172, 20037, 19901, 19765, 19630,
		19494, 19358, 19223, 19087, 18951, 18815, 18680, 18544,
		18408, 18273, 18137, 18002, 17867, 17731, 17596, 17461,
		17327, 17192, 17058, 16923, 16789, 16655, 16522, 16388,
		16255, 16122, 15989, 15857, 15725, 15593, 15461, 15330,
		15199, 15068, 14938, 14808, 14678, 14549, 14420, 14291,
		14163, 14035, 13908, 13781, 13654, 13528, 13402, 13277,
		13152, 13027, 12903, 12780, 12657, 12534, 12412, 12291,
		12170, 12049, 11929, 11810, 11691, 11572, 11454, 11337,
		11220, 11104, 10988, 10873, 10759, 10645, 10531, 10419,
		10306, 10195, 10084,  9974,  9864,  9755,  9646,  9539,
		 9431,  9325,  9219,  9114,  9009,  8905,  8802,  8699,
		 8597,  8496,  8395,  8295,  8196,  8097,  7999,  7902,
		 7805,  7710,  7614,  7520,  7426,  7333,  7240,  7149,
		 7058,  6967,  6878,  6789,  6700,  6613,  6526,  6440,
		 6355,  6270,  6186,  6103,  6020,  5938,  5857,  5776,
		 5697,  5618,  5539,  5462,  5385,  5308,  5233,  5158,
		 5084,  5010,  4938,  4866,  4794,  4724,  4654,  4585,
		 4516,  4448,  4381,  4314,  4249,  4183,  4119,  4055,
		 3992,  3930,  3868,  3807,  3746,  3687,  3628,  3569,
		 3511,  3454,  3398,  3342,  3287,  3232,  3178,  3125,
		 3072,  3020,  2969,  2918,  2868,  2819,  2770,  2721,
		 2674,  2627,  2580,  2534,  2489,  2444,  2400,  2357,
		 2314,  2271,  2229,  2188,  2147,  2107,  2068,  2029,
		 1990,  1952,  1915,  1878,  1841,  1805,  1770,  1735,
		 1701,  1667,  1634,  1601,  1569,  1537,  1506,  1475,
		 1444,  1414,  1385,  1356,  1327,  1299,  1272,  1245,
		 1218,  1192,  1166,  1140,  1115,  1091,  1066,  1043,
		 1019,   996,   974,   952,   930,   908,   887,   867,
		  846,   827,   807,   788,   769,   750,   732,   714,
		  697,   680,   663,   646,   630,   614,   599,   584,
		  569,   554,   540,   526,   512,   498,   485,   472,
		  459,   447,   435,   423,   411,   400,   389,   378,
		  367,   357,   347,   337,   327,   317,   308,   299,
		  290,   281,   273,   265,   256,   249,   241,   233,
		  226,   219,   212,   205,   198,   192,   186,   179,
		  173,   168,   162,   156,   151,   146,   141,   136,
		  131,   126,   122,   117,   113,   109,   104,   100,
		   97,    93,    89,    86,    82,    79,    76,    73,
		   70,    67,    64,    61,    58,    56,    53,    51,
		   48,    46,    44,    42,    40,    38,    36,    34,
		   32,    31,    29,    27,    26,    24,    23,    22,
		   20,    19,    18,    17,    16,    15,    14,    13,
		   12,    11,    10,     9,     8,     8,     7,     7,
		    6,     5,     5,     5,     4,     4,     3,     3,
		    3,     3,     2,     2,     2,     2,     2,     2
#endif
};

__attribute__( ( always_inline ) ) __STATIC_INLINE uint32_t __SMULBB(uint32_t op1, uint32_t op2)
{
  uint32_t result;
  __ASM volatile ("smulbb %0, %1, %2" : "=r" (result) : "r" (op1), "r" (op2) );
  return(result);
}
__attribute__( ( always_inline ) ) __STATIC_INLINE uint32_t __SMULTT(uint32_t op1, uint32_t op2)
{
  uint32_t result;
  __ASM volatile ("smultt %0, %1, %2" : "=r" (result) : "r" (op1), "r" (op2) );
  return(result);
}


// copy samples from 16bit into 32bit with applying window function
inline static void
window_complex_15to31(q31_t *dest, q15_t *s1, q15_t *s2, size_t length, const q15_t *wf)
{
	length /= 4;
	while (length-- > 0) {
		uint32_t w = *__SIMD32(wf)++;
		uint32_t i1i2 = *__SIMD32(s1)++;
		uint32_t q1q2 = *__SIMD32(s2)++;
		*dest++ = __SMULBB(i1i2, w);
		*dest++ = __SMULBB(q1q2, w);
		*dest++ = __SMULTT(i1i2, w);
		*dest++ = __SMULTT(q1q2, w);
	}
}


struct {
	void *ibuf;
	void *qbuf;
	uint32_t length;
	spectrumdisplay_param_t param;
} spdisp_source[SPDISP_MODE_MAX] = {
		{ CAPTUREBUFFER0, NULL, CAPTUREBUFFER_SIZEHALF/sizeof(uint16_t),
				{ 12000000, 0, 2, 5,	 	0, 42, 0, 1, "MHz" } },
		{ CAPTUREBUFFER0, NULL, CAPTUREBUFFER_SIZEHALF/sizeof(uint16_t),
				{ 12000000, 511, -1, 5,	 	0, 83, 6, 1, "MHz" } },
		{ I_FIR_BUFFER, Q_FIR_BUFFER, FIR_BUFFER_SIZE/sizeof(uint16_t),
				{ 80000, -480, 3, 0,		160, 43, 0, 10, "kHz" } },
		{ IIR_I_BUFFER, IIR_Q_BUFFER, IIR_BUFFER_SIZE/sizeof(uint16_t),
				{ 8000, -480, 3, 0,			160, 43, 0, 1, "kHz" } },
		{ AUD_I_BUFFER, AUD_Q_BUFFER, IIR_BUFFER_SIZE/sizeof(uint16_t),
				{ 8000, -480, 3, 0,			160, 43, 0, 1, "kHz" } },
		{ AUD_BUFFER, NULL, IIR_BUFFER_SIZE/sizeof(uint16_t),
				{ 8000, 0, 2, 0,			0, 64, 0, 1, "kHz" } }
};

//int16_t spdisp_fetch_mode;

q31_t *spdisp_fetch_current = SPDISP_BUFFER;
uint32_t spdisp_fetch_rest = 0;
const int16_t *spdisp_wf_current = winfunc_table;

inline static void
window_real_15to31(q31_t *dest, q15_t *s1, size_t length, const q15_t *wf)
{
	uint32_t offset = 0x08000800;
	uint32_t mask = 0xFFF0FFF0;
	uint16_t adj = spdisp_source[UISTAT->spdispmode].ibuf == CAPTUREBUFFER0;
	length /= 4;
	while (length-- > 0) {
		uint32_t w = *__SIMD32(wf)++;
		uint32_t i1i2 = *__SIMD32(s1)++;
		if (adj)
			i1i2 = (__QSUB16(i1i2, offset) << 4) & mask;
		*dest++ = __SMULBB(i1i2, w);
		*dest++ = 0;
		*dest++ = __SMULTT(i1i2, w);
		*dest++ = 0;
	}
}

void
spdisp_fetch_start()
{
	spdisp_fetch_rest = 0;
	// show tick on first event
	SPDISPINFO->update_flag = FLAG_UI;
}

void
spdisp_fetch_samples()
{
	if (spdisp_fetch_rest == 0) {
		if (SPDISPINFO->update_flag & FLAG_SPDISP) {
			// currently proccessing in M0APP
			return;
		}
		spdisp_fetch_current = SPDISP_BUFFER;
		spdisp_fetch_rest = SPDISP_BUFFER_SIZE / sizeof(q31_t);
		spdisp_wf_current = winfunc_table;
	}

	size_t length = spdisp_fetch_rest;
	uint16_t mode = UISTAT->spdispmode;
	if (length > spdisp_source[mode].length * 2)
		length = spdisp_source[mode].length * 2;
	if (spdisp_source[mode].qbuf == NULL) {
		window_real_15to31(spdisp_fetch_current, spdisp_source[mode].ibuf, length, spdisp_wf_current);
	} else {
		window_complex_15to31(spdisp_fetch_current, spdisp_source[mode].ibuf, spdisp_source[mode].qbuf, length, spdisp_wf_current);
	}
	spdisp_fetch_current += length;
	spdisp_fetch_rest -= length;
	spdisp_wf_current += length/2;

	if (spdisp_fetch_rest == 0) {
		SPDISPINFO->p = spdisp_source[mode].param;
		SPDISPINFO->buffer = SPDISP_BUFFER;
		SPDISPINFO->update_flag |= FLAG_SPDISP;
		if (SPDISPINFO->ui_update_flag) {
			SPDISPINFO->update_flag |= FLAG_UI;
			SPDISPINFO->ui_update_flag = FALSE;
		}
		// send event to M0APP
		__SEV();
	}
}


__RAMFUNC(RAM)
void DMA_IRQHandler (void)
{
  if (LPC_GPDMA->INTERRSTAT & 1)
  {
    LPC_GPDMA->INTERRCLR = 1;
  }

  if (LPC_GPDMA->INTTCSTAT & 1)
  {
	LPC_GPDMA->INTTCCLEAR = 1;

	clear_qflag();
	TESTPOINT_ON();
    if ((capture_count & 1) == 0) {
    	cic_decimate(&cic_i, CAPTUREBUFFER0, CAPTUREBUFFER_SIZEHALF);
    	cic_decimate(&cic_q, CAPTUREBUFFER0, CAPTUREBUFFER_SIZEHALF);
    } else {
    	cic_decimate(&cic_i, CAPTUREBUFFER1, CAPTUREBUFFER_SIZEHALF);
    	cic_decimate(&cic_q, CAPTUREBUFFER1, CAPTUREBUFFER_SIZEHALF);
    }
    if (check_qflag())
    	ovf_flags |= OVF_CIC;
#if 1
    TESTPOINT_SPIKE();
    finetune_mixer();
    TESTPOINT_SPIKE();
	clear_qflag();
	resample_fir_filter();
    if (check_qflag())
    	ovf_flags |= OVF_FIR;
    TESTPOINT_SPIKE();
	clear_qflag();
    weaver_ssb_demod(current_modulation);
    if (check_qflag())
    	ovf_flags |= OVF_IIR;
#endif

	TESTPOINT_OFF();
    capture_count ++;

#if 1
    /* check ADC overflow and underflow status flags, then clear them */
#define ADC_OVF (1<<5)
#define ADC_UNF (1<<6)
	if (LPC_VADC->STATUS0 & (ADC_OVF | ADC_UNF)) {
    	ovf_flags |= OVF_ADC;
    	LPC_VADC->CLR_STAT0 = ADC_OVF | ADC_UNF;
	}
#endif

	spdisp_fetch_samples();

    {
    	// toggle LED with every 1024 interrupts
    	int c = capture_count % 1024;
    	if (c == 0)
    	 	LED_ON();
    	else if (c == 512)
    	 	LED_OFF();
    }
  }
#if 0
  {
	  static int first = TRUE;
	  if (first) {
		pwmout_setupdma((uint16_t*)AUDIO_BUFFER, AUDIO_BUFFER_SIZE/sizeof(uint16_t));
		first = FALSE;
	  }
  }
#endif
}

__RAMFUNC(RAM)
void I2S0_IRQHandler()
{
#if 1
	uint32_t txLevel = I2S_GetLevel(LPC_I2S0, I2S_TX_MODE);
	//TESTPOINT_ON();
	if (txLevel < 8) {
		// Fill the remaining FIFO
		int cur = audio_state.read_current;
		int16_t *buffer = (int16_t*)AUDIO_BUFFER;
		int i;
		for (i = 0; i < (8 - txLevel); i++) {
			uint32_t x = *(uint32_t *)&buffer[cur]; // read TWO samples
			LPC_I2S0->TXFIFO = x;//__PKHTB(x, x, 0);
			cur += 2;
			cur %= AUDIO_BUFFER_SIZE / 2;
			audio_state.read_total += 2;
		}
		audio_state.read_current = cur;
	}
	//TESTPOINT_OFF();
#endif
}

void
dsp_init()
{
	cic_init();
	//generate_test_tone(440);
	spdisp_fetch_start();
}
